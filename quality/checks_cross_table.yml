# Checks that validate relationships and consistency between tables

checks for fact_daily_metrics:
  
  - failed rows:
      fail: when > 0
      fail query: |
        SELECT f.date_id, f.date, d.date as dim_date
        FROM fact_daily_metrics f
        JOIN dim_date d ON f.date_id = d.date_id
        WHERE f.date != d.date
      name: "fact_daily_metrics.date should match dim_date.date for same date_id"
  
  # Staging to fact data consistency 
  - failed rows:
      fail: when > 0
      fail query: |
        SELECT f.date, f.usd_egp_rate, s.usd_egp_rate as stg_rate
        FROM fact_daily_metrics f
        JOIN stg_exchange_rates s ON f.date = s.date
        WHERE f.usd_egp_rate IS NOT NULL
          AND s.usd_egp_rate IS NOT NULL
          AND ABS(f.usd_egp_rate - s.usd_egp_rate) > 0.0001
      name: "fact_daily_metrics.usd_egp_rate should match stg_exchange_rates.usd_egp_rate"

